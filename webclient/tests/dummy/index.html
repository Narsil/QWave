<html>
<head>
<title>Web Client Dummy</title>
<script src="rpc.js" type="text/javascript"></script>
<script src="common.pbjson.js" type="text/javascript"></script>
<script src="waveclient-rpc.pbjson.js" type="text/javascript"></script>
<script src="webclient.pbjson.js" type="text/javascript"></script>
<script src="jsot.js" type="text/javascript"></script>
</head>
<body>
	<h1>Log-In</h1>
	
	<form>
	  <p>User JID: <input type="text" id="jid" value="tux@wave1.vs.uni-due.de" /></p>
	  <p><input type="button" value="Login" onclick="login()" /></p>
	  <p><input type="button" value="NewWave" onclick="newWave()" /></p>
	</form>

	<h3>Session ID</h3>
	<p id="sessionId">No session ID yet</p>

	<h3>Protocol</h3>
	<div id="out"></div>

	<script type="text/javascript">
	
var sessionId = "";
var clientSequenceNr = 0;
var serverSequenceNr = 0;
var serverAck = 0;

function login()
{
  var r = new webclient.Request();
  r.session_id = sessionId;
  r.client_ack = serverSequenceNr;
  r.client_sequence_number = ++clientSequenceNr;
  r.login = new webclient.LoginRequest();
  r.login.jid = document.getElementById('jid').value;
  var json = JSON.stringify(r.serialize());
  callServer( json, onMessage );
}

function toArray(str)
{
  result = [];
  for( var i = 0; i < str.length; ++i )
  {
	result.push( str.charCodeAt(i) );
  }
  return result;
}

function newWave()
{
  var waveid = "w+" + Math.random().toString();
  var r = new webclient.Request();
  r.session_id = sessionId;
  r.client_ack = serverSequenceNr;
  r.client_sequence_number = ++clientSequenceNr;
  r.submit = new waveserver.ProtocolSubmitRequest();
  r.submit.wavelet_name = "wave://wave1.vs.uni-due.de/" + waveid + "/conv+root";
  r.submit.delta = new protocol.ProtocolWaveletDelta();
  r.submit.delta.author = document.getElementById('jid').value;
  r.submit.delta.hashed_version = new protocol.ProtocolHashedVersion();
  r.submit.delta.hashed_version.version = 0;
  r.submit.delta.hashed_version.history_hash = toArray( r.submit.wavelet_name );
  var op1 = new protocol.ProtocolWaveletOperation();
  op1.add_participant = document.getElementById('jid').value;
  r.submit.delta.operation.push( op1 );
  var op2 = new protocol.ProtocolWaveletOperation();
  op2.mutate_document = new protocol.ProtocolWaveletOperation_MutateDocument();
  op2.mutate_document.document_id = "conversation";
  op2.mutate_document.document_operation = new protocol.ProtocolDocumentOperation();
  var docop = op2.mutate_document.document_operation;
  docop.component.push( protocol.ProtocolDocumentOperation.newElementStart( "conversation" ) );
  docop.component.push( protocol.ProtocolDocumentOperation.newElementStart( "blip", [ protocol.ProtocolDocumentOperation.newKeyValuePair( "id", "b+1" ) ] ) );
  docop.component.push( protocol.ProtocolDocumentOperation.newElementEnd() );
  docop.component.push( protocol.ProtocolDocumentOperation.newElementEnd() );
  r.submit.delta.operation.push( op2 );
  var op3 = new protocol.ProtocolWaveletOperation();
  op3.mutate_document = new protocol.ProtocolWaveletOperation_MutateDocument();
  op3.mutate_document.document_id = "b+1";
  op3.mutate_document.document_operation = new protocol.ProtocolDocumentOperation();
  var docop = op3.mutate_document.document_operation;
  docop.component.push( protocol.ProtocolDocumentOperation.newElementStart( "body" ) );
  docop.component.push( protocol.ProtocolDocumentOperation.newElementStart( "line" ) );
  docop.component.push( protocol.ProtocolDocumentOperation.newCharacters( "Hallo" ) );
  docop.component.push( protocol.ProtocolDocumentOperation.newElementEnd() );
  docop.component.push( protocol.ProtocolDocumentOperation.newElementEnd() );
  r.submit.delta.operation.push( op3 );

  r.open = new waveserver.ProtocolOpenRequest();
  r.open.participant_id = document.getElementById('jid').value;
  r.open.wave_id = waveid;

  var json = JSON.stringify(r.serialize());
  console.log(r);
  callServer( json, null );  
}

function onMessage(jsonData)
{
  var response = webclient.Response.parse( JSON.parse( jsonData ) );
  // Get the ack of the server
  serverAck = Math.max(response.server_ack, serverAck);
  // Get the latest server sequence number  
  if ( response.server_sequence_number > 0 )
    serverSequenceNr = response.server_sequence_number;
  if ( response.has_login() )
  {
    var login = response.login;    
    sessionId = login.session_id;
    document.getElementById("sessionId").innerHTML = sessionId;

    var r = new webclient.Request();
    r.session_id = sessionId;
    r.client_ack = serverSequenceNr;
    r.client_sequence_number = ++clientSequenceNr;
    r.open = new waveserver.ProtocolOpenRequest();
    r.open.participant_id = document.getElementById('jid').value;
    r.open.wave_id = "!indexwave";
    var json = JSON.stringify(r.serialize());
    callServer( json, onMessage );
  }
  else if (response.has_update())
  {
    var update = response.update;
	
	JSOT.Wave.process( update );
	
	// Print the indexwave
	var wave = JSOT.Wave.getWave( "!indexwave", "wave1.vs.uni-due.de" );
	for( var a in wave.wavelets )
	{
		var wavelet = wave.wavelets[a];
		var c = document.createElement("pre");
		c.appendChild( document.createTextNode( wavelet.toString() ) );
		document.getElementById("out").appendChild(c);
	}
	
	// Ask for more
    var r = new webclient.Request();
    r.session_id = sessionId;
    r.client_ack = serverSequenceNr;
    r.client_sequence_number = 0;
    var json = JSON.stringify(r.serialize());
    callServer( json, onMessage );
  }

}

	</script>
</body>
</html>